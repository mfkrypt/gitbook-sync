# Exploiting Permission Delegation

Permission delegation is the process of granting specific permissions or authority to a user, group, or system to perform certain tasks to access resources. It is commonly used to allow controlled access without sharing full credentials or privileges

Permission Delegation exploits are often referred to as ACL-based attacks. AD allows administrators to configure Access Control Entries (ACEs) that populates Discretionary Access Control Lists (DACLs), hence the name ACL-based attacks. Almost any AD object can be secured with ACEs. However, if these ACEs are misconfigured, it may be possible for an attacker to exploit them.

***

### <mark style="color:green;">Exploiting ACEs</mark>

A significant amount of ACEs can be misconfigured, come of them are:

* <mark style="background-color:orange;">**ForceChangePassword**</mark>: We have the ability to set the user's current password without knowing their current password.
* <mark style="background-color:orange;">**AddMembers**</mark>: We have the ability to add users (including our own account), groups or computers to the target group.
* <mark style="background-color:orange;">**GenericAll**</mark>**:** We have complete control over the object, including the ability to change the user's password, register an SPN or add an AD object to the target group.
* <mark style="background-color:orange;">**GenericWrite**</mark>: Full write access to the group object, including modifying members, changing descriptions, and even escalating privileges further.
* <mark style="background-color:orange;">**WriteOwner**</mark>**:** We have the ability to update the owner of the target object. We could make ourselves the owner, allowing us to gain additional permissions over the object.
* <mark style="background-color:orange;">**WriteDACL**</mark>**:** We have the ability to write new ACEs to the target object's DACL. We could, for example, write an ACE that grants our account full control over the target object.
* <mark style="background-color:orange;">**AllExtendedRights**</mark>**:** We have the ability to perform any action associated with extended AD rights against the target object. This includes, for example, the ability to force change a user's password.

***

### <mark style="color:green;">Tiering</mark>

Before proceeding we need to know what is tiering. It is basically a model that is designed to manage assets in a centralized way using least privilege as the core concept.

<figure><img src="../../../.gitbook/assets/image (252).png" alt=""><figcaption></figcaption></figure>

* _**Tier-0** – Forest and Domain Administrators_: Direct or indirect administrative control over the Active Directory forest, domains, or domain controller (DC). This includes administrative access to storage devices that contain Active Directory database files.
* _**Tier-1** – Server Administrators_: Direct or indirect administrative control over a single or multiple servers that do not fall into Tier-0. Business critical servers are also in this tier.
* _**Tier-2** – Workstation Administrators, User Administrators, Helpdesk Technicians_: Direct or indirect administrative control over a single or multiple devices and day-to-day user accounts.

***

***

<figure><img src="../../../.gitbook/assets/image (626).png" alt=""><figcaption></figcaption></figure>

### <mark style="color:green;">Bloodhound</mark>

For this room, Sharphound was already executed and the data was given in a zip fle

<figure><img src="../../../.gitbook/assets/image (249).png" alt=""><figcaption></figcaption></figure>

Start neo4j

```bash
sudo neo4j console
```

On another tab start Bloodhound

```bash
bloodhound
```

<figure><img src="../../../.gitbook/assets/image (248).png" alt=""><figcaption></figcaption></figure>

Change the username and password if needed. My credentials are `neo4j:root`

Upload the data zip file

<figure><img src="../../../.gitbook/assets/image (250).png" alt=""><figcaption></figcaption></figure>

### <mark style="color:green;">Privilege Escalation</mark>

If we search for our user account that was assigned in DNS configuration, we can see we have the ability to RDP into THMWRK1 Workstation, but this will only provide us with low-privileged access because we are in the "Domain Users" group

<figure><img src="../../../.gitbook/assets/image (254).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (255).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (256).png" alt=""><figcaption></figcaption></figure>

We need to compromise the _Tier 2 Admins_ group since this group has administrative privileges on all workstations. We can ask Bloodhound if there is perhaps a road that we can follow to compromise this group.

<figure><img src="../../../.gitbook/assets/image (257).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (260).png" alt=""><figcaption></figcaption></figure>

As we can see, the IT Support group misconfigured the Permission Delegation with the **GenericWrite** ACE. This means we can modify the members by adding our user to the IT Support Group.&#x20;

Furhtermore, Bloodhound shows that the _IT Support_ Group has the **ForceChangePassword** ACE for the _Tier 2 Admins_ group members. We can change the password of any Tier 2 admins and hijack their account gaining Admin access to the TMHWRK1 Workstation.

First, SSH into the credentials and run Powershell

<figure><img src="../../../.gitbook/assets/image (261).png" alt=""><figcaption></figcaption></figure>

Add user into the IT Group

```powershell
Add-ADGroupMember "IT Support" -Members "Your.AD.Account.Username"
```

Verify it by listing

```powershell
Get-ADGroupMember -Identity "IT Support"
```

<figure><img src="../../../.gitbook/assets/image (262).png" alt=""><figcaption></figcaption></figure>

Now we abuse the **ForceChangePassword** ACE. Choose any users from this group. I will go with `t2_ross.bird`

```powershell
Get-ADGroupMember -Identity "Tier 2 Admins"
```

<figure><img src="../../../.gitbook/assets/image (263).png" alt=""><figcaption></figcaption></figure>

Set the password and reset it

```powershell
$Password = ConvertTo-SecureString "New.Password.For.User" -AsPlainText -Force
Set-ADAccountPassword -Identity "AD.Account.Username.Of.Target" -Reset -NewPassword $Password 
```

SSH into target

<figure><img src="../../../.gitbook/assets/image (264).png" alt=""><figcaption></figcaption></figure>

NIce. Noe we should be able to retrieve the flag in Administrator's Desktop

<figure><img src="../../../.gitbook/assets/image (265).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (266).png" alt=""><figcaption></figcaption></figure>
